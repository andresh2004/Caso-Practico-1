pipeline {
    agent any

    
    environment {
        VENV_DIR = 'venv'
    }

    stages {
        stage('Get Code') {
            steps {
                checkout scm
                bat 'whoami'
                bat 'hostname'
                bat 'echo $WORKSPACE'
            }
        }

        stage('Setup Environment') {
            steps {
                bat '''
                    C:\Users\USER\AppData\Local\Programs\Python\Python313\python.exe
                    call venv\\Scripts\\activate
                    C:\Users\USER\AppData\Local\Programs\Python\Python313\Scripts\pip.exe pip install -r requirements.txt
                '''
            }
        }

        stage('Unit Tests') {
            steps {
                bat '''
                    . ${VENV_DIR}/bin/activate
                    pytest test/unit --junitxml=unit_report.xml
                '''
            }
            post {
                always {
                    junit 'unit_report.xml'
                }
            }
        }

        stage('Static Analysis (flake8)') {
            steps {
                bat '''
                    . ${VENV_DIR}/bin/activate
                    flake8 app/ --exit-zero --format=default > flake8_report.txt
                '''
            }
            post {
                always {
                    recordIssues enabledForFailure: true, tool: flake8(pattern: 'flake8_report.txt')
                }
            }
        }

        stage('Security Test (bandit)') {
            steps {
                bat '''
                    . ${VENV_DIR}/bin/activate
                    bandit -r app/ -f xml -o bandit_report.xml || true
                '''
            }
            post {
                always {
                    recordIssues enabledForFailure: true, tool: bandit(pattern: 'bandit_report.xml')
                }
            }
        }

        stage('Coverage') {
            steps {
                bat '''
                    . ${VENV_DIR}/bin/activate
                    coverage run -m pytest test/unit
                    coverage xml -o coverage.xml
                '''
            }
            post {
                always {
                    cobertura coberturaReportFile: 'coverage.xml'
                }
            }
        }

        stage('Performance (JMeter)') {
            steps {
                bat '''
                    jmeter -n -t jmeter/test_plan.jmx -l jmeter/report.jtl -e -o jmeter/report
                '''
            }
            post {
                always {
                    perfReport sourceDataFiles: 'jmeter/report.jtl'
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
